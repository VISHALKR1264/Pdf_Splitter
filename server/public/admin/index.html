<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Client Admin Panel</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      header { display: flex; align-items: baseline; gap: 12px; }
      table { border-collapse: collapse; width: 100%; margin-top: 16px; }
      th, td { border: 1px solid #ddd; padding: 8px; }
      th { background: #f1f3f5; text-align: left; }
      button { padding: 6px 10px; border: 1px solid #222; background: #fff; cursor: pointer; border-radius: 6px; }
      button:hover { background: #f4f4f4; }
      .toolbar { display: flex; gap: 8px; margin-top: 12px; }
      .danger { border-color: #c92a2a; color: #c92a2a; }
    </style>
  </head>
  <body>
    <header>
      <h1>Client Admin Panel</h1>
      <span id="health">checking...</span>
    </header>

    <div class="toolbar">
      <button id="refresh">Refresh</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>UID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Last Seen</th>
          <th>Tokens</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <script>
      async function getJSON(url, opts) {
        const res = await fetch(url, opts);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      async function refresh() {
        try {
          const health = await getJSON('/api/health');
          document.getElementById('health').textContent = health.firebaseReady ? 'Connected' : 'Not connected to Firebase';
        } catch (e) {
          document.getElementById('health').textContent = 'Server error';
        }

        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        try {
          const { users } = await getJSON('/api/users');
          if (!users || users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No users found</td></tr>';
            return;
          }
          tbody.innerHTML = '';
          for (const u of users) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${u.uid}</td>
              <td>${u.displayName ?? ''}</td>
              <td>${u.email ?? ''}</td>
              <td>${u.lastSeenAt ?? ''}</td>
              <td>${u.fcmTokensCount ?? 0}</td>
              <td><button class="danger" data-uid="${u.uid}">Wipe</button></td>
            `;
            tbody.appendChild(tr);
          }
        } catch (e) {
          tbody.innerHTML = `<tr><td colspan="6">Failed to load users: ${e.message}</td></tr>`;
        }

        document.querySelectorAll('button.danger').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const uid = ev.currentTarget.getAttribute('data-uid');
            if (!confirm(`Wipe all data for UID ${uid}? This cannot be undone.`)) return;
            try {
              await getJSON(`/api/wipe/${uid}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reason: 'Admin panel action' }) });
              alert('Wipe initiated');
              refresh();
            } catch (e) {
              alert('Wipe failed: ' + e.message);
            }
          });
        });
      }

      document.getElementById('refresh').addEventListener('click', refresh);
      refresh();
    </script>
  </body>
</html>